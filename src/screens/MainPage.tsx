import {
  Button,
  Flex,
  Input,
  Modal,
  Radio,
  Text,
  Textarea,
  TextInput,
  Title,
} from "@mantine/core";
import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";

export default function MainPage(props: any) {
  const [authorization, setAuthorization] = useState("");
  const [authorizationType, setAuthorizationType] = useState("None");
  const [body, setBody] = useState("");
  const [contentType, setContentType] = useState("text\\plain");
  const [cors, setCors] = useState("");
  const [method, setMethod] = useState("GET");
  const [mode, setMode] = useState("no-cors");
  const [reponse, setResponse] = useState("");
  const [redirect, setRedirect] = useState("manual");
  const [url, setUrl] = useState("https://");
  const navigate = useNavigate();

  async function callFetch() {
    // Use defaults unless controls specify otherwise.
    let requestData = {
      method: "GET",
      headers: {
        //"Access-Control-Request-Method": "GET",
        "Access-Control-Allow-Origin": "*",
        //"Access-Control-Request-Headers": "origin, x-requested-with",
        //"Access-Control-Allow-Headers": "Content-Type",
        //Origin: "http://localhost:3000",
      },
    };

    if (method !== undefined && method.length > 0) {
      Object.assign(requestData, { method: method });
    }
    if (mode !== undefined && mode.length > 0) {
      Object.assign(requestData, { mode: mode });
    }
    if (
      authorization !== undefined &&
      authorization.length > 0 &&
      authorizationType !== "None"
    ) {
      Object.assign(requestData.headers, {
        Authorization: `${authorizationType}: ${authorization}`,
      });
    }
    if (contentType !== undefined && contentType.length > 0) {
      Object.assign(requestData.headers, { "Content-Type": contentType });
    }
    if (method !== "GET" && body.length > 0) {
      Object.assign(requestData, { body: JSON.stringify(body) });
    }

    console.log("sending request to " + url + "...");
    return fetch(url, requestData)
      .then((response) => {
        return response.text();
      })
      .then((data) => {
        setResponse(data ? data : "");
      });
  }

  // Kick unauthorized users to landing page.
  useEffect(() => {
    const queryParams = new URLSearchParams(window.location.search);
    if (queryParams.get("code")) {
      navigate("/authorize");
    } else if (!props.loggedIn) {
      navigate("/landing");
    }
  });

  return (
    <>
      <Flex direction="column" style={{ border: "solid", rowGap: "20px" }}>
        <Title size="h1" style={{ alignSelf: "center" }}>
          HTTP Request Form
        </Title>
        <Title fw={700} size="h3" style={{ alignSelf: "center" }}>
          Headers
        </Title>
        <TextInput
          label="Request URL:"
          value={url}
          onChange={(e) => setUrl(e.currentTarget.value)}
          style={{ width: "75%", alignSelf: "center" }}
        />
        <Radio.Group
          name="Method"
          label="Method:"
          value={method}
          onChange={setMethod}
          style={{ width: "75%", alignSelf: "center" }}
        >
          <Radio value="GET" label="GET" />
          <Radio value="POST" label="POST" />
        </Radio.Group>
        <TextInput
          label="Content-Type:"
          value={contentType}
          onChange={(e) => setContentType(e.currentTarget.value)}
          style={{ width: "75%", alignSelf: "center" }}
        />
        <TextInput
          label="Authorization String:"
          value={authorization}
          onChange={(e) => setAuthorization(e.currentTarget.value)}
          style={{ width: "75%", alignSelf: "center" }}
        />
        <Radio.Group
          name="Authorization Type"
          label="Authorization Type:"
          value={authorizationType}
          onChange={setAuthorizationType}
          style={{ width: "75%", alignSelf: "center" }}
        >
          <Radio value="None" label="None" />
          <Radio value="Basic" label="Basic" />
          <Radio value="Bearer" label="Bearer" />
        </Radio.Group>
        <Radio.Group
          name="Redirect"
          label="Redirect:"
          value={redirect}
          onChange={setRedirect}
          style={{ width: "75%", alignSelf: "center" }}
        >
          <Radio value="manual" label="manual" />
          <Radio value="follow" label="follow" />
          <Radio value="error" label="error" />
        </Radio.Group>
        <Radio.Group
          name="Mode"
          label="Mode:"
          value={mode}
          onChange={setMode}
          style={{ width: "75%", alignSelf: "center" }}
        >
          <Radio value="no-cors" label="no-cors" />
          <Radio value="cors" label="cors" />
          <Radio value="same-origin" label="same-origin" />
        </Radio.Group>
        <Textarea
          label="Body:"
          value={body}
          onChange={(e) => setBody(e.currentTarget.value)}
          size="md"
          autosize={true}
          style={{ width: "75%", alignSelf: "center" }}
        ></Textarea>
        <br />
      </Flex>
      <Button onClick={callFetch}>Send</Button>
      <Textarea label="Response" disabled value={reponse}></Textarea>
    </>
  );
}
