import {
  Button,
  Flex,
  Input,
  Modal,
  Text,
  Textarea,
  TextInput,
  Title,
} from "@mantine/core";
import { appendDataToDatabase, ResetDatabase } from "../utils/DropboxApi";
import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";

export default function MainPage(props: any) {
  const [authorization, setAuthorization] = useState("");
  const [contentType, setContentType] = useState("text\\plain");
  const [method, setMethod] = useState("GET");
  const [reponse, setResponse] = useState("");
  const [url, setUrl] = useState("https://");
  const navigate = useNavigate();

  function callGET() {
    fetch(url, {
      method: method,
      headers: {},
    })
      .then((n) => n.json())
      .then((m) => {
        setResponse(m.ToString());
      });
  }

  function callNonGET() {
    fetch(url, {
      method: method,
      headers: {
        Authorization: "Bearer " + process.env.REACT_APP_TWITTER_BEARER_TOKEN,
        "Content-Type": contentType,
      },
      body: "",
    })
      .then((n) => n.json())
      .then((m) => {
        setResponse(m.ToString());
      });
  }

  function callFetch() {
    if (method === "GET") {
      callGET();
    } else {
      callNonGET();
    }
  }

  // Kick unauthorized users to landing page.
  useEffect(() => {
    const queryParams = new URLSearchParams(window.location.search);
    if (queryParams.get("code")) {
      navigate("/authorize");
    } else if (!props.loggedIn) {
      navigate("/landing");
    }
  });

  return (
    <>
      <Title size="h1">Send HTTP Request</Title>
      <Flex direction="column" style={{ border: "solid" }}>
        <Text>Headers:</Text>
        <TextInput
          label="URL"
          value={url}
          onChange={(e) => setUrl(e.currentTarget.value)}
        />
        <TextInput
          label="Method"
          value={method}
          onChange={(e) => setMethod(e.currentTarget.value)}
        />
        <TextInput
          label="Content-Type"
          value={contentType}
          onChange={(e) => setContentType(e.currentTarget.value)}
        />
        <TextInput
          label="Authorization"
          value={authorization}
          onChange={(e) => setContentType(e.currentTarget.value)}
        />
      </Flex>
      <Button onClick={callFetch}>Send</Button>
      <Textarea label="Response" disabled value={reponse}></Textarea>
    </>
  );
}
